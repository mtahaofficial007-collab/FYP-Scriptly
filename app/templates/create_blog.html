{% extends "base.html" %}

{% block title %}Generate Blog | ScriptlyAI{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/blog.css') }}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="dashboard-layout">

 <nav class="dashboard-sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                 <span>Scriptly</span>
            </div>
        </div>

        <div class="sidebar-menu">
            {% set path = request.path %}

            <a href="{{ url_for('blog.home') }}" class="{{ 'active' if path == url_for('blog.home') else '' }}">
                <i class="bi bi-speedometer2"></i> <span>Home</span>
            </a>
            <a href="{{ url_for('blog.create_page') }}" class="{{ 'active' if path == url_for('blog.create_page') else '' }}">
                <i class="bi bi-plus-circle"></i> <span>Create Blog</span>
            </a>
            <a href="{{ url_for('blog.drafts_page') }}" class="{{ 'active' if path == url_for('blog.drafts_page') else '' }}">
                <i class="bi bi-file-earmark-richtext"></i> <span>My Drafts</span>
            </a>
            <a href="{{ url_for('blog.categories_page') }}" class="{{ 'active' if path == url_for('blog.categories_page') else '' }}">
                <i class="bi bi-tags"></i> <span>Categories</span>
            </a>
            <a href="{{ url_for('blog.approval_page') }}" class="{{ 'active' if path == url_for('blog.approval_page') else '' }}">
                <i class="bi bi-shield-check"></i> <span>Admin Approval</span>
            </a>
            <a href="/users" class="{{ 'active' if path == '/users' else '' }}">
                <i class="bi bi-people-fill"></i> <span>User Management</span>
            </a>    
            
            <a href="{{url_for('auth_bp.logout')}}" class="logout mt-auto">
                <i class="bi bi-box-arrow-right"></i> <span>Logout</span>
            </a>
        </div>

        <div class="sidebar-footer text-center">
            <span>User ID</span>
            <small>{{ session.get('user_id', 'N/A') }}</small>
        </div>
    </nav>

  <main class="dashboard-main">

    <header class="dashboard-header">
      <h1>Generate Blog</h1>
    </header>

    <div class="blog-center-wrapper">

      <div class="floating-gradient-circle">
        <img src="{{ url_for('static', filename='images/gradient-circle.png') }}" alt="Gradient">
      </div>

      <div class="welcome-user">
        <span class="welcome-text">Welcome</span>
        <span class="welcome-name">{{ username }}</span>
      </div>

      <div class="blog-thought-heading">
        <span class="text-black">What's on your</span>
        <span class="text-gradient">mind today?</span>
      </div>

      <div class="prompt-box">
        <textarea id="prompt" class="prompt-input" placeholder="Describe your blog topic in detail..." rows="1"
          oninput="autoResize(this)" onkeydown="handleKeyPress(event)"></textarea>

        <button onclick="handleGeneration()" id="genBtn" class="prompt-submit" type="button">
          <i class="bi bi-stars"></i>
        </button>
      </div>

      <div id="loader" class="mt-4 d-none text-center">
        <div class="spinner-border text-primary mb-2" role="status"></div>
        <p class="text-secondary">AI Agents are collaborating on your content...</p>
      </div>

    </div>

  </main>
</div>

<script>
  /**
   * Automatically adjusts the height of the textarea as the user types
   */
  function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
  }

  /**
   * Listens for Enter key. 
   * Enter = Submit
   * Shift + Enter = New Line
   */
  function handleKeyPress(event) {
    if (event.key === "Enter" && !event.shiftKey) {
      event.preventDefault(); // Stop the cursor from going to a new line
      handleGeneration();
    }
  }

  /**
   * Handles the AI generation logic
   */
  async function handleGeneration() {
    const promptInput = document.getElementById('prompt');
    const promptText = promptInput.value.trim();
    const loader = document.getElementById('loader');
    const genBtn = document.getElementById('genBtn');

    if (!promptText) return;

    // Show loader and disable button
    loader.classList.remove('d-none');
    genBtn.disabled = true;

    try {
      // Clear the input and reset height immediately for a snappy feel
      promptInput.value = '';
      promptInput.style.height = 'auto';

      // Replace this URL with your actual API endpoint
      const response = await fetch('/api/generate_blog', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt: promptText })
      });

      const data = await response.json();
      
      if (data.success) {
        // Redirect or handle the newly generated blog
        window.location.href = data.redirect_url || "{{ url_for('blog.drafts_page') }}";
      } else {
        alert(data.error || "Generation failed. Please try again.");
      }
    } catch (err) {
      console.error("Error:", err);
      alert("Something went wrong. Check your connection.");
    } finally {
      // Hide loader and re-enable button
      loader.classList.add('d-none');
      genBtn.disabled = false;
    }
  }
</script>
{% endblock %}